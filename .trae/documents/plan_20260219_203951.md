
# 征服者游戏 - 基于特性的单位系统（含子特性）

## 1. 核心数据结构设计

### 1.1 特性系统（Trait）
- **Trait 接口**：
  - 唯一ID、名称、描述、类型
  - 前置特性依赖（requires）
  - 子特性列表（children）- 可以是标签或加成特性
  - 属性加成（stats）
  - 标签系统（tags）

### 1.2 子特性类型
- **标签子特性**：无属性，仅用于分类和匹配（如"冷兵器"、"轻甲"）
- **加成子特性**：给父特性提供额外属性加成

### 1.3 战斗关系表（CombatRelation）
- 支持特性ID或标签匹配
- 攻击方特性/标签 vs 防御方特性/标签

## 2. 示例数据结构

```json
{
  "traits": {
    "coldWeapon": {
      "id": "coldWeapon",
      "name": "冷兵器",
      "type": "tag",
      "description": "所有冷兵器的标签"
    },
    "lightArmor": {
      "id": "lightArmor",
      "name": "轻甲",
      "type": "tag",
      "description": "轻型护甲的标签"
    },
    "heavyArmor": {
      "id": "heavyArmor",
      "name": "重甲",
      "type": "tag",
      "description": "重型护甲的标签"
    },
    "infantry": {
      "id": "infantry",
      "name": "步兵",
      "type": "soldierType",
      "stats": { "hp": 100, "attack": 10, "defense": 15, "movement": 4, "range": 1 }
    },
    "sword": {
      "id": "sword",
      "name": "长剑",
      "type": "weapon",
      "requires": ["infantry"],
      "stats": { "attack": 5 },
      "children": ["coldWeapon"]
    },
    "chainmail": {
      "id": "chainmail",
      "name": "锁子甲",
      "type": "armor",
      "requires": ["infantry"],
      "stats": { "defense": 10 },
      "children": ["lightArmor"]
    },
    "archer": {
      "id": "archer",
      "name": "弓箭手",
      "type": "soldierType",
      "stats": { "hp": 80, "attack": 8, "defense": 8, "movement": 4, "range": 3 }
    },
    "longbow": {
      "id": "longbow",
      "name": "长弓",
      "type": "weapon",
      "requires": ["archer"],
      "stats": { "attack": 12, "range": 1 }
    },
    "leatherArmor": {
      "id": "leatherArmor",
      "name": "皮甲",
      "type": "armor",
      "requires": ["archer"],
      "stats": { "defense": 5 },
      "children": ["lightArmor"]
    },
    "plateArmor": {
      "id": "plateArmor",
      "name": "板甲",
      "type": "armor",
      "requires": ["infantry"],
      "stats": { "defense": 20, "movement": -1 },
      "children": ["heavyArmor"]
    }
  },
  "combatRelations": [
    {
      "attackerTrait": "coldWeapon",
      "defenderTrait": "lightArmor",
      "bonusType": "multiply",
      "value": 1.5,
      "description": "冷兵器克制轻甲"
    },
    {
      "attackerTrait": "longbow",
      "defenderTrait": "heavyArmor",
      "bonusType": "multiply",
      "value": 0.5,
      "description": "长弓对重甲效果减半"
    }
  ],
  "units": [
    {
      "id": "unit_1",
      "q": 2,
      "r": -1,
      "owner": "player",
      "traits": ["infantry", "sword", "chainmail"],
      "hp": 100
    },
    {
      "id": "unit_2",
      "q": 3,
      "r": 0,
      "owner": "enemy",
      "traits": ["archer", "longbow", "leatherArmor"],
      "hp": 80
    }
  ]
}
```

## 3. 核心功能模块

### 3.1 TraitManager 特性管理器
- 从场景数据加载特性
- 特性依赖解析
- 子特性展开（获取所有特性及其子特性）
- 标签收集（获取单位所有标签）

### 3.2 UnitStatsCalculator 属性计算器
- 从特性集合（包含子特性加成）计算最终属性
- 实现防御分式函数：`免伤率 = 防御 / (防御 + 100)`

### 3.3 CombatSystem 战斗系统
- 支持标签匹配的战斗加成计算
- 实现完整的战斗流程

## 4. 实现步骤

### 步骤1：核心类型定义
- 创建 `src/core/traits/types.ts`

### 步骤2：TraitManager 实现
- 特性加载、验证、子特性展开、标签收集

### 步骤3：重构 Unit 类
- 支持特性系统

### 步骤4：UnitStatsCalculator 实现
- 属性计算（包含子特性加成）

### 步骤5：CombatSystem 实现
- 支持标签匹配的战斗系统

### 步骤6：示例数据和集成
- 更新示例场景数据
