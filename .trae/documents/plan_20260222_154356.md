# 完整回合循环机制设计

## 当前问题

1. **回合数增加时机错误**: 每次 `endTurn()` 都增加，应该所有玩家轮完后才+1
2. **AI 回合后没有自动继续**: 需要检测下一个玩家并自动触发

## 回合循环机制

```
Turn 1:
  player (玩家) → 结束回合
    ↓
  enemy (AI) → 结束回合  
    ↓
  Turn++ → Turn 2
  
Turn 2:
  player → 结束回合
    ↓
  enemy → 结束回合
    ↓
  Turn++ → Turn 3
```

## 实现方案

### 1. 追踪机制
- `currentTurn`: 当前回合号
- `turnPhase`: 当前阶段 `'player'` | `'enemy'`

### 2. endTurn() 逻辑

```typescript
endTurn() {
  const currentPlayer = this.gameStore.currentPlayer;
  const players = this.gameStore.players;
  
  // 1. 切换到下一个玩家
  this.gameStore.nextPlayer();
  const nextPlayer = this.gameStore.currentPlayer;
  
  // 2. 检查是否完成了一轮 (所有玩家都走完了)
  // 条件: 当前玩家索引回到了 0 (第一个玩家)
  const completedRound = this.gameStore.currentPlayerIndex === 0;
  
  if (completedRound) {
    this.currentTurn++;  // 只有所有玩家都结束才增加回合
    debug.ui('Round completed, new turn:', this.currentTurn);
  }
  
  // 3. 更新 UI
  this.gameEventStore.setTurn(this.currentTurn);
  this.gameEventStore.setCurrentPlayer(nextPlayer.id);
  
  // 4. 如果是 AI，自动触发
  if (nextPlayer.isAI) {
    this.triggerAITurn();
  }
}
```

### 3. 完整的流程

```
玩家结束回合
  ↓
TurnSystem.endTurn()
  ↓
gameStore.nextPlayer() → 切换到下一个玩家
  ↓
判断: currentPlayerIndex === 0 ?
  ↓
是 → currentTurn++ (所有玩家都走完了)
否 → 不增加回合数
  ↓
检查 nextPlayer.isAI
  ↓
是 → triggerAITurn() → 1秒后自动 endTurn()
否 → 等待玩家操作
```

### 4. AI 回合触发逻辑修改

```typescript
private triggerAITurn(): void {
  if (this.isAITurn) return;
  this.isAITurn = true;
  
  debug.ui('AI turn started');
  
  setTimeout(() => {
    debug.ui('AI turn ended');
    this.isAITurn = false;
    this.endTurn();  // AI 结束自动触发下一个
  }, 1000);
}
```

## 关键点

- **回合增加条件**: `currentPlayerIndex === 0` (回到第一个玩家)
- **AI 自动轮转**: AI 结束后直接调用 `endTurn()` 形成循环