# GameModeSystem 重构计划

## 目标

将 `GameModeSystem.ts` 拆分为多个独立系统，降低耦合度，提高可维护性。

## 新目录结构

```
src/game/
├── systems/                    # 新建：游戏子系统目录
│   ├── TurnSystem.ts           # 回合管理系统（回合切换、玩家轮换）
│   ├── SelectionSystem.ts     # 选择系统（单位/地块选择、高亮）
│   ├── InputHandlerSystem.ts  # 输入处理系统（鼠标事件）
│   ├── SceneLoader.ts         # 场景加载系统（JSON加载）
│   └── index.ts               # 导出所有子系统
├── GameModeSystem.ts          # 重构：作为协调者，委托给各子系统
├── GameUI.vue
└── index.ts
```

***

## 拆分方案

### 1. TurnSystem (`TurnSystem.ts`)

**职责**：回合管理

* `endTurn()` - 回合结束，切换玩家

* `getCurrentTurn()` - 获取当前回合数

* `getCurrentPlayerId()` - 获取当前玩家ID

* `initialize()` - 初始化

**依赖**：`GameStore`, `GameEventStore`, `MovementSystem`, `UnitRenderSystem`

***

### 2. SelectionSystem (`SelectionSystem.ts`)

**职责**：选择与高亮

* `selectUnit(unitId)` - 选择单位

* `deselectUnit()` - 取消选择

* `selectTile(key, q, r)` - 选择地块

* `clearSelection()` - 清除所有选择

* `highlightAttackableTiles(unit)` - 高亮可攻击地块

* `clearAttackHighlights()` - 清除攻击高亮

**依赖**：`MapSystem`, `UnitRenderSystem`, `MovementSystem`, `TraitManager`, `GameEventStore`

***

### 3. InputHandlerSystem (`InputHandlerSystem.ts`)

**职责**：输入处理

* `setupInputHandlers()` - 设置鼠标事件监听

* `handleMouseDown(e)` - 处理鼠标点击

**依赖**：`EventBus`, `MapSystem`, `MovementSystem`, `UnitRenderSystem`, `SelectionSystem`, `TurnSystem`

***

### 4. SceneLoader (`SceneLoader.ts`)

**职责**：场景加载

* `loadDemoScene()` - 加载示例场景

* `loadSceneFromFolder(sceneId)` - 从文件夹加载场景数据

* `loadTraitData(traitsData)` - 加载特性数据

**依赖**：`MapSystem`, `MovementSystem`, `EdgeSystem`, `TraitManager`

***

### 5. GameModeSystem (重构后)

**职责**：协调者

* 持有所有子系统实例

* 初始化时创建并连接各子系统

* 通过子系统完成游戏逻辑

* 保留核心业务方法作为委托入口

***

## 实施步骤

1. **创建** **`src/game/systems/`** **目录**
2. \*\*创建 \`

